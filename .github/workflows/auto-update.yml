name: 自动更新规则（每8小时一次）
on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 8 * * *'
    - cron: '0 16 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予写入权限
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        # 移除 token 参数，使用默认 GITHUB_TOKEN（已授予 write 权限）

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装依赖包
        run: pip install requests

      - name: 运行规则整合脚本
        run: python main.py

      - name: 配置 Git 用户信息
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 提交并推送更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "✅ 自动更新规则（每8小时同步上游）"
          file_pattern: "merged_rules.txt"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          push_options: "--force"  # 强制推送（解决分支保护问题）
